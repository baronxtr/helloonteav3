<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello On Tea</title>
  <link rel="icon" type="image/png" href="https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafkreigo3jtctoslylhq2bv4ncfcdbbio5sui6qothcr4uml7dwydzvwq4">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      background: url(https://media.stockimg.ai/image/v2/It7y_e6p9B3Y.png) no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      position: relative;
    }
    .container {
      background: rgba(0, 128, 128, 0.9);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 128, 0.5);
      text-align: center;
      max-width: 600px;
      width: 100%;
      color: #fff;
      position: relative;
      z-index: 10; /* Ensure container is above loading image */
    }
    .content-box {
      border: 2px solid #000080;
      border-radius: 10px;
      padding: 20px;
      position: relative;
      padding-bottom: 40px;
    }
    .message-wrapper {
      border: 7px solid #000080; /* Navy border */
      border-radius: 15px;
      padding: 20px; /* Jarak dalam border */
      margin: 10px auto; /* Posisi tengah secara horizontal */
      max-width: 200px; /* Batasi panjang horizontal border */
      display: flex;
      flex-direction: column;
      align-items: center;
      background: url('https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafkreig3cq66j7uh5q65pqicty64pkvki4o3m2wmswo2ujdfqcyd5p7q2u') no-repeat center center;
      background-size: contain; /* Ensure the image fits within the wrapper */
      box-sizing: border-box; /* Ensure padding and border are included in width */
    }
    .message-box {
      background: url('https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafybeicl2ggu2svjmhynkpr5jxqpvp4bluajjz42z7ilyhm4zsjyk7mkku') no-repeat center center;
      background-size: 170px 85px;
      padding: 22px;
      border-radius: 5px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      top: -10px;
      width: 100%; /* Pastikan kotak pesan mengisi lebar wrapper */
    }
    .message-box span {
      color: #000; /* Fallback color, akan diganti oleh JavaScript */
      font-weight: bold;
    }
    .below-message-image {
      display: block;
      margin: -18px auto; /* Posisi tengah secara horizontal */
      width: 100px; /* Ukuran default, bisa disesuaikan */
      height: auto; /* Menjaga rasio aspek */
      border-radius: 5px; /* Sudut melengkung opsional */
    }
    .logo-inside {
      width: 100px;
      height: 100px;
      margin-bottom: 10px;
      border: 3px solid #90EE90;
      border-radius: 50%;
      padding: 5px;
      background: transparent;
    }
    h1 {
      font-family: 'Press Start 2P', cursive;
      color: #90EE90;
      font-size: 1.5em;
      margin-bottom: 20px;
      text-decoration: underline;
      text-decoration-color: #90EE90;
    }
    .wallet-section, .contract-section, .audio-section {
      margin: 20px 0;
    }
    button {
      font-family: 'Arial', sans-serif;
      background-color: #000080;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 14px;
    }
    button:hover:not(:disabled) {
      background-color: #003366;
    }
    button:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    #mintNFTButton, #sayHelloButton {
      width: 150px;
      margin: 5px;
    }
    input {
      font-family: 'Arial', sans-serif;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #008080;
      margin-right: 10px;
      width: 200px;
      font-size: 14px;
    }
    p {
      font-family: 'Arial', sans-serif;
      font-size: 1em;
      margin: 10px 0;
    }
    span {
      color: #e6f3f3;
      font-weight: bold;
    }
    .history-section {
      margin-top: 20px;
      text-align: left;
    }
    .history-section h3 {
      font-family: 'Arial', sans-serif;
      color: #000080;
      font-size: 1.2em;
    }
    .history-section ul {
      list-style: none;
      padding: 0;
      max-height: 150px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }
    .history-section li {
      font-family: 'Arial', sans-serif;
      padding: 5px;
      border-bottom: 1px solid #008080;
      display: flex;
      justify-content: space-between;
      align-items: center;
      white-space: nowrap;
      font-size: 0.9em;
    }
    .history-section li a {
      color: #000080;
      text-decoration: none;
      font-size: 0.9em;
    }
    .history-section li a:hover {
      text-decoration: underline;
    }
    .contract-address {
      font-family: 'Arial', sans-serif;
      font-size: 0.9em;
      color: #e6f3f3;
      margin-top: 10px;
    }
    .footer-text {
      font-family: 'Arial', sans-serif;
      position: absolute;
      bottom: 10px;
      left: 0;
      right: 0;
      text-align: center;
      color: #98FB98;
      font-size: 0.8em;
      z-index: 10;
    }
    .footer-text a {
      color: #98FB98;
      text-decoration: none;
      font-weight: bold;
    }
    .footer-text a:hover {
      color: #000080;
      text-decoration: underline;
    }
    .share-buttons {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .share-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .twitter-share-button {
      background-color: #1DA1F2;
    }
    .twitter-share-button:hover {
      background-color: #0d95e8;
    }
    .farcaster-share-button {
      background-color: #8A63D2;
    }
    .farcaster-share-button:hover {
      background-color: #7a52b3;
    }
    .error-message {
      font-family: 'Arial', sans-serif;
      color: #ff4d4d;
      font-size: 0.9em;
      margin-top: 5px;
      display: none;
    }
    .audio-section {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .leaderboard-section {
      margin-top: 20px;
      text-align: left;
      display: none;
    }
    .leaderboard-section h3 {
      font-family: 'Arial', sans-serif;
      color: #000080;
      text-align: center;
      font-size: 1.2em;
    }
    .leaderboard-section ul {
      list-style: none;
      padding: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
    }
    .leaderboard-section li {
      font-family: 'Arial', sans-serif;
      padding: 8px;
      border-bottom: 1px solid #008080;
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
    }
    .leaderboard-section li.user-wallet {
      color: #000080;
      font-weight: bold;
    }
    .user-position {
      font-family: 'Arial', sans-serif;
      margin-top: 10px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      text-align: center;
      font-size: 0.9em;
      color: #000080;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 128, 128, 0.9);
      padding: 20px;
      border: 2px solid #000080;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 128, 0.5);
      text-align: center;
      color: #fff;
      z-index: 1000;
      max-width: 400px;
      width: 90%;
    }
    .popup h2 {
      font-family: 'Press Start 2P', cursive;
      color: #90EE90;
      font-size: 1.2em;
      margin-bottom: 15px;
      text-decoration: underline;
      text-decoration-color: #90EE90;
    }
    .popup img {
      width: 200px;
      height: 200px;
      margin-bottom: 10px;
      border: 3px solid #90EE90;
      border-radius: 10px;
    }
    .popup .nft-contract-address {
      font-family: 'Arial', sans-serif;
      font-size: 0.8em;
      color: #e6f3f3;
      margin-bottom: 5px;
      word-wrap: break-word;
    }
    .popup .nft-supply-info {
      font-family: 'Arial', sans-serif;
      font-size: 0.8em;
      color: #e6f3f3;
      margin-bottom: 15px;
    }
    .popup p {
      font-size: 0.9em;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    .popup a {
      color: #90EE90;
      text-decoration: underline;
    }
    .popup button {
      width: 120px;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .running-text-container {
      width: 100%;
      overflow: hidden;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .running-text {
      font-family: 'Arial', sans-serif;
      font-size: 0.9em;
      color: #ffcc00;
      white-space: nowrap;
      display: inline-block;
      animation: marquee 20s linear infinite; /* Diperpanjang menjadi 25 detik untuk teks yang lebih panjang */
    }
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    .loading-image {
      display: none; /* Initially hidden */
      position: fixed;
      top: 50%; /* Center vertically */
      left: 50%; /* Center horizontally */
      transform: translate(-50%, -50%); /* Adjust for image dimensions */
      width: 200px; /* Adjustable size */
      height: auto; /* Maintain aspect ratio */
      z-index: 1001; /* Above other elements but below popups */
    }
  </style>
</head>
<body>
  <img src="https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafkreidon7gjte4e6q4qgugpdzhsb3ptlxsabg62qr64x54khwkycz76qi" alt="Loading" class="loading-image" id="loadingImage" loading="lazy">
  <div class="overlay" id="popupOverlay"></div>
  <div class="popup" id="nftPopup">
    <h2>Hello on Tea</h2>
    <img src="https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafybeiageou2qvzdpiqjfr5lfzxvc4usucdswqw3yqu36tjvcor7scm5yq" alt="NFT Image" loading="lazy">
    <p class="nft-contract-address">Contract: 0xFbA581414A171B940001295B8BB61584EA43Ad86</p>
    <p class="nft-supply-info" id="nftSupplyInfo">Minted: Loading... / 10,000</p>
    <p>A special NFT from 'Hello on Tea' DApp, celebrating your contribution on Tea Sepolia Testnet!</p>
    <button id="confirmMintButton">Mint (0.1 TEA)</button>
  </div>
  <div class="popup" id="mintProgressPopup">
    <h2>Minting Progress</h2>
    <p id="mintProgressMessage">Please wait, NFT being minted...</p>
  </div>
  <div class="container">
    <div class="content-box">
      <img src="https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafkreigo3jtctoslylhq2bv4ncfcdbbio5sui6qothcr4uml7dwydzvwq4" alt="Logo Inside" class="logo-inside" loading="lazy">
      <h1>Hello on Tea</h1>
      <div class="wallet-section">
        <button id="connectButton">Connect Wallet</button>
        <p>Wallet: <span id="account">Not connected</span></p>
      </div>
      <div class="contract-section">
        <div class="message-wrapper">
          <div class="message-box">
            <span id="currentMessage">Loading...</span>
          </div>
          <img src="https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafybeifiqdt73vgfqah62n677ty36ihlr4xnsltj6vkvsrlt7zdde4gfge" alt="Below Message Image" class="below-message-image" loading="lazy">
        </div>
        <p>Total Clicks: <span id="clickCount">Loading...</span></p>
        <p>Total Wallets Interacted: <span id="totalWallets">Loading...</span></p>
        <p class="contract-address">Contract: 0x073CF9B93A3F40A4B5e8634DA06Bf5A63545780E</p>
        <button id="sayHelloButton" disabled>Say Hello</button>
        <button id="mintNFTButton" disabled>Mint NFT</button>
        <div class="message-input">
          <input type="text" id="newMessage" placeholder="Set a new message" maxlength="15">
          <button id="setMessageButton" disabled>Update Message</button>
          <p id="errorMessage" class="error-message"></p>
        </div>
        <div class="running-text-container">
          <div class="running-text">
            Notice: Due to high traffic on Tea Sepolia, data updates on Hello on Tea may experience delays. For faster and smoother transactions, sign up for an Alchemy account and add private Tea Sepolia RPC to your wallet.
          </div>
        </div>
        <div class="share-buttons">
          <button id="twitterShareButton" class="twitter-share-button">Share on Twitter</button>
          <button id="farcasterShareButton" class="farcaster-share-button">Share on Farcaster</button>
        </div>
      </div>
      <div class="history-section">
        <h3>Say Hello History</h3>
        <ul id="helloHistory"></ul>
      </div>
      <div class="audio-section">
        <button id="audioButton">Play Music</button>
        <button id="leaderboardButton">Leaderboard</button>
        <audio id="backgroundAudio" loop src="https://fcb2f4e08c25f8c7f8e218352d8f51d0.ipfs.4everland.link/ipfs/bafybeic7dc7ezpi6cdarec4rdhwla532h45di7dkbj3hrziqifgcbslsoq"></audio>
      </div>
      <div class="leaderboard-section" id="leaderboardSection">
        <h3>Top 50 Wallets by Interactions</h3>
        <ul id="leaderboardList"></ul>
        <div id="userPosition" class="user-position"></div>
      </div>
      <div class="footer-text">Build by <a href="https://x.com/0xdor" target="_blank" rel="noopener noreferrer">@0xdor</a></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" async></script>
  <script>
    // Function to generate a random dark color
    function getRandomDarkColor() {
      const r = Math.floor(Math.random() * 128); // 0-127 to keep it dark
      const g = Math.floor(Math.random() * 128);
      const b = Math.floor(Math.random() * 128);
      return `rgb(${r}, ${g}, ${b})`;
    }

    // Apply random dark color initially
    document.addEventListener('DOMContentLoaded', () => {
      const messageSpan = document.querySelector('.message-box span');
      messageSpan.style.color = getRandomDarkColor();
      setupEventListener(); // Setup event listener on page load
    });

    console.log('Ethers.js loaded:', typeof ethers);
    const teaSepoliaConfig = {
      chainId: '0x27ea',
      chainName: 'Tea Sepolia',
      rpcUrls: ['https://tea-sepolia.g.alchemy.com/public'],
      nativeCurrency: {
        name: 'TEA',
        symbol: 'TEA',
        decimals: 18
      },
      blockExplorerUrls: ['https://sepolia.tea.xyz']
    };

    const contractAddress = '0x073CF9B93A3F40A4B5e8634DA06Bf5A63545780E';
    const contractABI = [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"message","type":"string"},{"indexed":false,"internalType":"uint256","name":"count","type":"uint256"}],"name":"HelloSaid","type":"event"},
      {"inputs":[],"name":"sayHello","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"newMessage","type":"string"}],"name":"setMessage","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"clickCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"message","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}
    ];

    const nftContractAddress = "0xFbA581414A171B940001295B8BB61584EA43Ad86";
    const nftContractABI = [
      {"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"safeMint","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},
      {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"MAX_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"MINT_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"pure","type":"function"},
      {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"pure","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let provider, signer, contract, nftContract, account;

    const connectButton = document.getElementById('connectButton');
    const sayHelloButton = document.getElementById('sayHelloButton');
    const mintNFTButton = document.getElementById('mintNFTButton');
    const confirmMintButton = document.getElementById('confirmMintButton');
    const setMessageButton = document.getElementById('setMessageButton');
    const twitterShareButton = document.getElementById('twitterShareButton');
    const farcasterShareButton = document.getElementById('farcasterShareButton');
    const accountDisplay = document.getElementById('account');
    const currentMessageDisplay = document.getElementById('currentMessage');
    const clickCountDisplay = document.getElementById('clickCount');
    const totalWalletsDisplay = document.getElementById('totalWallets');
    const newMessageInput = document.getElementById('newMessage');
    const errorMessageDisplay = document.getElementById('errorMessage');
    const helloHistory = document.getElementById('helloHistory');
    const audioButton = document.getElementById('audioButton');
    const backgroundAudio = document.getElementById('backgroundAudio');
    const leaderboardButton = document.getElementById('leaderboardButton');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const leaderboardList = document.getElementById('leaderboardList');
    const userPosition = document.getElementById('userPosition');
    const popupOverlay = document.getElementById('popupOverlay');
    const nftPopup = document.getElementById('nftPopup');
    const nftSupplyInfo = document.getElementById('nftSupplyInfo');
    const mintProgressPopup = document.getElementById('mintProgressPopup');
    const mintProgressMessage = document.getElementById('mintProgressMessage');
    const loadingImage = document.getElementById('loadingImage');

    const inappropriateWords = [
      "damn", "fuck", "shit", "bitch", "asshole", "porn", "sex", "nude", "xxx",
      "anjing", "babi", "kontol", "memek", "bangsat", "sialan", "porno", "telanjang",
      "puta", "merde", "cul", "concha", "joder", "cabrón",
    ];

    const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9-]+\.[a-zA-Z]{2,}[^\s]*)/i;

    function getOrdinal(n) {
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function validateMessage(message) {
      const lowerCaseMessage = message.toLowerCase();
      for (const word of inappropriateWords) {
        if (lowerCaseMessage.includes(word)) {
          return { isValid: false, error: "Message contains inappropriate words. Please revise." };
        }
      }
      if (urlRegex.test(message)) {
        return { isValid: false, error: "Links are not allowed to prevent spam or phishing." };
      }
      return { isValid: true };
    }

    function showLoadingImage() {
      loadingImage.style.display = 'block';
      setTimeout(hideLoadingImage, 4000); // Hide after 4 seconds
    }

    function hideLoadingImage() {
      loadingImage.style.display = 'none';
    }

    async function setupEventListener() {
      // Initialize provider without signer (for read-only access)
      const readOnlyProvider = new ethers.providers.JsonRpcProvider(teaSepoliaConfig.rpcUrls[0]);
      const readOnlyContract = new ethers.Contract(contractAddress, contractABI, readOnlyProvider);

      // Listen for HelloSaid events from any user
      readOnlyContract.on('HelloSaid', (user, message, count, event) => {
        console.log(`Event detected - User: ${user}, Message: ${message}, Count: ${count}`);
        updateContractData(); // Update UI whenever event is emitted
      });

      console.log('Event listener setup for HelloSaid');
    }

    async function connectWallet() {
      console.log('Connect Wallet clicked');
      if (!window.ethereum) {
        alert('Please install MetaMask!');
        console.log('MetaMask not detected');
        return;
      }

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const { chainId } = await provider.getNetwork();
        if (chainId !== 10218) {
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: teaSepoliaConfig.chainId }],
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [teaSepoliaConfig],
              });
            } else {
              throw switchError;
            }
          }
        }

        signer = provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        nftContract = new ethers.Contract(nftContractAddress, nftContractABI, signer);

        accountDisplay.textContent = `${account.slice(0, 6)}...${account.slice(-4)}`;
        connectButton.textContent = 'Connected';
        connectButton.disabled = true;
        sayHelloButton.disabled = false;
        mintNFTButton.disabled = false;
        setMessageButton.disabled = false;
        console.log('Connected to Tea Sepolia with account:', account);

        updateContractData();
        loadHelloHistory();
      } catch (error) {
        console.error('Connection error:', error.message);
        alert('Failed to connect: ' + error.message);
      }
    }

    async function updateContractData() {
      try {
        const message = await contract.message();
        const count = await contract.clickCount();
        currentMessageDisplay.textContent = message;
        clickCountDisplay.textContent = count.toString();

        // Update text color to a random dark color every time the message updates
        currentMessageDisplay.style.color = getRandomDarkColor();

        const filter = contract.filters.HelloSaid(null);
        const events = await contract.queryFilter(filter);
        const uniqueWallets = new Set(events.map(event => event.args.user));
        totalWalletsDisplay.textContent = uniqueWallets.size.toString();

        updateLeaderboard(events);
      } catch (error) {
        console.error(`Error fetching data: ${error.message}`);
      }
    }

    async function loadHelloHistory() {
      helloHistory.innerHTML = '';
      const filter = contract.filters.HelloSaid(account);
      const events = await contract.queryFilter(filter);
      events.forEach(event => {
        const li = document.createElement('li');
        const messageText = `Said "${event.args.message}" at count ${event.args.count.toString()}`;
        
        const messageSpan = document.createElement('span');
        messageSpan.textContent = messageText;
        
        const explorerLink = document.createElement('a');
        const txHash = event.transactionHash;
        const shortTxHash = `${txHash.slice(0, 6)}...${txHash.slice(-4)}`;
        const explorerUrl = `https://sepolia.tea.xyz/tx/${txHash}`;
        explorerLink.href = explorerUrl;
        explorerLink.textContent = shortTxHash;
        explorerLink.target = '_blank';
        explorerLink.rel = 'noopener noreferrer';
        
        li.appendChild(messageSpan);
        li.appendChild(explorerLink);
        
        helloHistory.appendChild(li);
      });
    }

    async function updateNFTSupply() {
      try {
        const totalSupply = await nftContract.totalSupply();
        const maxSupply = await nftContract.MAX_SUPPLY();
        nftSupplyInfo.textContent = `Minted: ${totalSupply.toString()} / ${maxSupply.toString()}`;
      } catch (error) {
        console.error('Error fetching NFT supply:', error.message);
        nftSupplyInfo.textContent = `Minted: Error / 10,000`;
      }
    }

    async function handleSayHello() {
      try {
        console.log('Sending sayHello transaction...');
        const tx = await contract.sayHello(); // User signs here
        showLoadingImage(); // Show loading image after signing
        await tx.wait();
        console.log('Hello said!');
        updateContractData();
        loadHelloHistory();
      } catch (error) {
        console.error(`Error: ${error.message}`);
      }
    }

    async function handleSetMessage() {
      const newMessage = newMessageInput.value.trim();
      if (!newMessage) {
        errorMessageDisplay.textContent = "Please enter a message.";
        errorMessageDisplay.style.display = "block";
        return;
      }

      if (newMessage.length > 15) {
        errorMessageDisplay.textContent = "Message must be 15 characters or less.";
        errorMessageDisplay.style.display = "block";
        return;
      }

      const validation = validateMessage(newMessage);
      if (!validation.isValid) {
        errorMessageDisplay.textContent = validation.error;
        errorMessageDisplay.style.display = "block";
        return;
      }

      try {
        errorMessageDisplay.style.display = "none";
        console.log('Sending setMessage transaction...');
        const tx = await contract.setMessage(newMessage); // User signs here
        showLoadingImage(); // Show loading image after signing
        await tx.wait();
        console.log('Message updated!');
        newMessageInput.value = '';
        updateContractData();
        loadHelloHistory();
      } catch (error) {
        console.error(`Error: ${error.message}`);
        errorMessageDisplay.textContent = "Failed to update message. Please try again.";
        errorMessageDisplay.style.display = "block";
      }
    }

    function showNFTPopup() {
      popupOverlay.style.display = 'block';
      nftPopup.style.display = 'block';
      updateNFTSupply();
    }

    function hideNFTPopup() {
      popupOverlay.style.display = 'none';
      nftPopup.style.display = 'none';
    }

    function showMintProgressPopup(message) {
      mintProgressMessage.innerHTML = message;
      popupOverlay.style.display = 'block';
      mintProgressPopup.style.display = 'block';
    }

    function hideMintProgressPopup() {
      popupOverlay.style.display = 'none';
      mintProgressPopup.style.display = 'none';
    }

    async function handleMintNFT() {
      try {
        console.log('Minting NFT...');
        showMintProgressPopup("Please wait, NFT being minted...");
        const tx = await nftContract.safeMint(account, {
          value: ethers.utils.parseEther("0.1")
        });
        console.log('Transaction sent, waiting for confirmation...');
        const receipt = await tx.wait();
        console.log('NFT minted! Transaction hash:', receipt.transactionHash);
        const txHashLink = `<a href="https://sepolia.tea.xyz/tx/${receipt.transactionHash}" target="_blank">View Transaction</a>`;
        showMintProgressPopup(`Successfully minted NFT! ${txHashLink}`);
        setTimeout(hideMintProgressPopup, 5000); // Hide after 5 seconds
        updateNFTSupply();
        hideNFTPopup();
      } catch (error) {
        console.error('Error minting NFT:', error.message);
        if (error.code === 4001) {
          showMintProgressPopup("User canceled the transaction.");
        } else if (error.code === -32603) {
          showMintProgressPopup("Transaction failed: Insufficient funds or network error.");
        } else {
          showMintProgressPopup(`Failed to mint NFT: ${error.message}`);
        }
        setTimeout(hideMintProgressPopup, 5000); // Hide after 5 seconds
      }
    }

    function shareOnTwitter() {
      const tweetText = "Say 'Hello on Tea' on Tea Sepolia! 🍵 A fun DApp to connect, message, and vibe with the @teaprotocol community. Try it now: https://helloontea.vercel.app #teaprotocol #Web3 ";
      const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
      window.open(tweetUrl, '_blank');
    }

    function shareOnFarcaster() {
      const postText = "Say 'Hello on Tea' on Tea Sepolia! 🍵 A fun DApp to connect, message, and vibe with the @teaprotocol community. Try it now: https://helloontea.vercel.app #teaprotocol #Web3 ";
      const farcasterUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(postText)}`;
      window.open(farcasterUrl, '_blank');
    }

    async function updateLeaderboard(events) {
      const walletInteractions = {};
      events.forEach(event => {
        const wallet = event.args.user;
        walletInteractions[wallet] = (walletInteractions[wallet] || 0) + 1;
      });

      const sortedWallets = Object.entries(walletInteractions)
        .sort((a, b) => b[1] - a[1])
        .map(([wallet, count], index) => ({ wallet, count, rank: index + 1 }));

      leaderboardList.innerHTML = '';
      const top50 = sortedWallets.slice(0, 50);
      top50.forEach(({ wallet, count, rank }) => {
        const li = document.createElement('li');
        const shortWallet = `${wallet.slice(0, 6)}...${wallet.slice(-4)}`;
        li.textContent = `${rank}. ${shortWallet} ${count} messages`;

        if (account && wallet.toLowerCase() === account.toLowerCase()) {
          li.classList.add('user-wallet');
        }

        leaderboardList.appendChild(li);
      });

      if (account) {
        const userData = sortedWallets.find(data => data.wallet.toLowerCase() === account.toLowerCase());
        if (userData) {
          const { rank } = userData;
          userPosition.textContent = `Your Position: ${getOrdinal(rank)}`;
        } else {
          userPosition.textContent = `Your Position: Not ranked yet. Say Hello to join!`;
        }
      } else {
        userPosition.textContent = `Connect your wallet to see your position!`;
      }
    }

    let isPlaying = false;
    audioButton.addEventListener('click', () => {
      if (isPlaying) {
        backgroundAudio.pause();
        audioButton.textContent = 'Play Music';
        isPlaying = false;
      } else {
        backgroundAudio.play();
        audioButton.textContent = 'Mute Music';
        isPlaying = true;
      }
    });

    let isLeaderboardVisible = false;
    leaderboardButton.addEventListener('click', () => {
      isLeaderboardVisible = !isLeaderboardVisible;
      leaderboardSection.style.display = isLeaderboardVisible ? 'block' : 'none';
      leaderboardButton.textContent = isLeaderboardVisible ? 'Hide Leaderboard' : 'Leaderboard';
      if (isLeaderboardVisible) {
        updateContractData();
      }
    });

    connectButton.addEventListener('click', connectWallet);
    sayHelloButton.addEventListener('click', handleSayHello);
    mintNFTButton.addEventListener('click', showNFTPopup);
    confirmMintButton.addEventListener('click', handleMintNFT);
    popupOverlay.addEventListener('click', hideNFTPopup);
    setMessageButton.addEventListener('click', handleSetMessage);
    twitterShareButton.addEventListener('click', shareOnTwitter);
    farcasterShareButton.addEventListener('click', shareOnFarcaster);
  </script>
</body>
</html>
